<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pflanzenbewässerung Dashboard</title>
  <style>
    /*Maximale anzustrebende Größe: 1MB */
    body {
      font-family: Arial, sans-serif;
      color: green;
      background: #1d1c1c;
      margin: 0;
      padding: 2rem;
    }
    h1 {
        text-align: center;
        font-family: 'Times New Roman', Times, serif;
        font-size: 35pt;
    }
    .Pot_Nr {
      text-align: center;
      font-family: 'Times New Roman', Times, serif;
      text-decoration: underline;
      color: green;
      font-size: xx-large;
    }
    .plant_card {
      background: rgb(0, 0, 0);
      color: green;
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 6px green;

    }
     .plant_grid {
      display: grid;
      color: green;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
     }
     .Feuchte {
      
     }
     .Threshold {
      
     }
     .AirTemp {
      
     }
     .AirHumidity {
      
     }
/*CHATGPT*/
.input_row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 0.5rem 0;
}

.input_row label {
  flex: 1;
  color: green;
}

.input_row input {
  width: 3rem;
  text-align: right;
}
/*CHATGPT*/
  </style>
</head>
<body>
    <h1>
        Gewächshausomat
    </h1>

<div class = "plant_grid" id = "plant_grid">

</div>    
<script>
  //Funktionen:

Loop10()
setInterval(Loop10, 30000);

//regelmäßig aktualisieren, hier drüber auf 10s gesetzt
function Loop10() {
  document.getElementById("plant_grid").innerHTML = ""
  get_sensors().then((sensors) => {
    console.log(sensors);
    for(var pot of sensors)
  {
  //pot ist hier die variable mit der er arbeitet
    CreateDashboard(pot);
  } 
  });
}
  //Daten von API ziehen
  async function get_sensors() {
    let result_list = []
    let sensor_path = "/sensors";
    let sensors = await fetch(sensor_path).then(res => res.json());
    //for each zu schnell, mit for geht er alles einzeln durch
    for(var element of sensors)
    {
    let sensor_id = "/sensor/" + element;
    let sensor_data = await fetch(sensor_id).then(res => res.json());
    result_list.push(sensor_data);
    }  
  return result_list}

  //Kästen erstellen
 function CreateDashboard(details_pot) {
  let plant = document.createElement("div")
  plant.className = "plant_card"
  
  //$: aus der Liste was ziehen (überarbeitet mit CHATGPT)
  plant.innerHTML = `
  <h2 class="Pot_Nr">${details_pot["id"]}</h2>
  <div class="Feuchte">Feuchtigkeit: <b> ${details_pot["moisture"]} </b> </div>
  <div class="Threshold">Schwellwert: <b> ${details_pot["threshold"]} </b> </div>`

  if (details_pot["temperature"] != null) {
  plant.innerHTML+=`<div class="AirTemp">Temperatur: <b> ${details_pot["temperature"]} </b> </div>`
  }

  if (details_pot["humidity"] != null) {
    plant.innerHTML+=`<div class="AirHumidity">Luftfeuchtigkeit: <b> ${details_pot["humidity"]} </b> </div>`
  }

  plant.innerHTML+=`
  <div class="input_row">
    <label>Neuer Schwellenwert:</label>
    <input type="number" min="1200" max="2000" step="10" value="${details_pot["threshold"]}" id="${details_pot["id"]}_newinputthreshold">
  </div>

  <div class="input_row">
    <label>Wartezeit (min):</label>
    <input type="number" min="1" max="120" step="1" value="${details_pot["backoff_time"]}" id="${details_pot["id"]}_newinputbackofftime">
  </div>

  <div class="input_row">
    <label>Wässerungszeit (s):</label>
    <input type="number" min="1" max="120" step="1"value="${details_pot["watering_time"]}" id="${details_pot["id"]}_newinputwateringtime">
  </div>

  <button type="submit" onclick="send_new_input('${details_pot["id"]}')">Senden</button>
`;
  document.getElementById("plant_grid").appendChild(plant)
 } 

 //Funktion für Button "Senden" (CHATGPT)
function send_new_input(potId) {
  const threshold = document.getElementById(`${potId}_newinputthreshold`).value;
  const backoffTime = document.getElementById(`${potId}_newinputbackofftime`).value;
  const wateringTime = document.getElementById(`${potId}_newinputwateringtime`).value;

  const data = {
    id: parseInt(potId), 
    watering_time: parseInt(wateringTime, 10),
    backoff_time: parseInt(backoffTime, 10),
    threshold: parseInt(threshold, 10)
  };

  console.log("Gesammelte Eingaben als JSON:");
  console.log(data);
 
 let upload = "/sensor" 
 fetch(upload, {
   method: 'Post',
   headers: {
     'Content-Type': 'application/json'
   },
   body: JSON.stringify(data)
 })
}
</script>

</body>
</html>